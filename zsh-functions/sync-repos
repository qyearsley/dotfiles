#!/usr/bin/env zsh
# Sync all branches in repos in ~/src

function sync-repos() {
    local src_dir="$HOME/src"
    local skipped_repos=()
    local sync_all=false

    # Parse arguments
    for arg in "$@"; do
        if [[ "$arg" == "--help" || "$arg" == "-h" ]]; then
            echo "Usage: sync-repos [--all]"
            echo ""
            echo "Sync repos in ~/src (updates main branch by default)"
            echo ""
            echo "Options:"
            echo "  --all      Sync all branches (not just main)"
            echo "  -h, --help Show this help message"
            return 0
        elif [[ "$arg" == "--all" ]]; then
            sync_all=true
        fi
    done

    # Find all git repos
    for repo in "$src_dir"/*(/); do
        if [[ -d "$repo/.git" ]]; then
            local repo_name="${repo:t}"
            pushd "$repo" > /dev/null

            # Check for uncommitted changes
            if ! git diff-index --quiet HEAD 2>/dev/null; then
                skipped_repos+=("$repo_name (uncommitted changes)")
                popd > /dev/null
                continue
            fi

            if [[ "$sync_all" == "true" ]]; then
                # Sync all branches
                echo "Syncing all branches in $repo_name"
                sync-branches "$@"
            else
                # Just update main branch
                echo "Syncing main branch in $repo_name"
                local base_branch="$(git-base-branch)"
                local current_branch="$(git branch --show-current)"

                git fetch origin || {
                    popd > /dev/null
                    continue
                }

                git checkout "$base_branch"
                git pull --ff-only origin "$base_branch"

                # Return to original branch if different
                if [[ "$current_branch" != "$base_branch" ]]; then
                    git checkout "$current_branch"
                fi
            fi

            popd > /dev/null
        fi
    done

    # Report skipped repos
    if (( ${#skipped_repos[@]} > 0 )); then
        echo ""
        echo "Skipped repos:"
        for skip in "${skipped_repos[@]}"; do
            echo "  - $skip"
        done
    fi
}

# If called directly (not sourced), run the function
if [[ "${BASH_SOURCE[0]}" == "${0}" ]] || [[ "${(%):-%x}" == "${0}" ]]; then
    sync-repos "$@"
fi
